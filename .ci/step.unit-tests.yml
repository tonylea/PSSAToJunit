parameters:
  - name: operatingSystem
    type: string
  - name: dependencyConfigPath
    type: string
  - name: psakeFilePath
    type: string
  - name: testResultsPath
    type: string
  - name: unitTestsFolder
    type: string
  - name: utilScriptPath
    type: string

steps:
  - pwsh: |
      $UtilScriptPathArgs = @{
        DependencyConfigPath = $env:DEPENDENCY_CONFIG_PATH
        Task                 = "InstallDependencies"
      }
      . $env:UTIL_SCRIPTPATH @UtilScriptPathArgs
    env:
      UTIL_SCRIPTPATH: ${{ parameters.utilScriptPath }}
      DEPENDENCY_CONFIG_PATH: ${{ parameters.dependencyConfigPath }}
    displayName: install dependencies
    workingDirectory: $(System.DefaultWorkingDirectory)

  - pwsh: |
      $UtilScriptPathArgs = @{
        PSakeFilepath = $env:PSAKE_FILEPATH
        Task          = "UnitTests"
      }
      . $env:UTIL_SCRIPTPATH @UtilScriptPathArgs
    env:
      UTIL_SCRIPTPATH: ${{ parameters.utilScriptPath }}
      PSAKE_FILEPATH: ${{ parameters.psakeFilePath }}
      TEST_RESULTS_PATH: ${{ parameters.testResultsPath }}
      UNIT_TESTS_FOLDER: ${{ parameters.unitTestsFolder }}
    displayName: run pester tests
    workingDirectory: $(System.DefaultWorkingDirectory)

  - task: PublishTestResults@2
    displayName: publish test results
    condition: succeededOrFailed()
    inputs:
      testResultsFormat: "JUnit"
      testResultsFiles: "**/**.xml"
      searchFolder: "${{ parameters.testResultsPath }}"
      mergeTestResults: false
      testRunTitle: ${{ parameters.operatingSystem }}-unit-tests
      failTaskOnFailedTests: true
      publishRunAttachments: true

  - task: PublishCodeCoverageResults@1
    displayName: publish code coverage
    condition: succeededOrFailed()
    inputs:
      codeCoverageTool: JaCoCo
      summaryFileLocation: "**/${{ parameters.operatingSystem }}-code-coverage.xml"
      failIfCoverageEmpty: true

  - template: ./step.clean-up-tests.yml
    parameters:
      testResultsPath: ${{ parameters.testResultsPath }}
